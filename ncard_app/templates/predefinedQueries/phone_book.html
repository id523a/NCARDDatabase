{% extends 'events/base.html' %}
{% load crispy_forms_tags %}

{% block title %}Phone Book{% endblock %}

{% block content%}
<h1 class="mb-4">Phone Book</h1>
<button class="btn btn-primary mb-3" onclick="getExport()">Export</button>
<table id="query-form" class="table table-striped table-bordered border-dark">
    <tr>
        <th scope="col"> Title </th>
        <th scope="col"> Full Name </th>
        <th scope="col"> Organization Name </th>
        <th scope="col"> Phone(office) </th>
        <th scope="col"> Phone(Mobile) </th>
        <th scope="col"> Email </th>
    </tr>
    {% for ele in data %}
        <tr>
            <td>
                {{ ele.primary_contact.title }}
            </td>
            <td>
                {{ ele.primary_contact.full_name }}
            </td>
            <td>
                {{ ele.name }}
            </td>
            <td>
                {{ ele.primary_contact.contact.phone_office }}
            </td>
            <td>
                '{{ ele.primary_contact.contact.phone_mobile }}'
            </td>
            <td>
                {{ ele.primary_contact.contact.email }}
            </td>
        </tr>
    {% endfor %}
</table>
{% endblock %}


{% block custom_js %}
<script>
    function quoteCSV(str) {
        const escaped_str = str.replaceAll('"', '""');
        return `"${escaped_str}"`;
    }

    function getExport() {
        const table = document.getElementById("query-form");
        let csvContent = "";
        for (let i = 0, rows = table.rows.length; i < rows; i++) {
            for (let j = 0, cells = table.rows[i].cells.length; j < cells; j++) {
                if (j !== 0) {
                    csvContent += ",";
                }
                csvContent += quoteCSV(table.rows[i].cells[j].innerText);
            }
            csvContent += "\n";
        }

        const a = document.createElement('a');
        const blob = new Blob([csvContent], {type: "data:text/csv;charset=utf-8,"});
        const url = URL.createObjectURL(blob);
        a.setAttribute('href', url);
        a.setAttribute('download', "organisation.csv");
        a.click();
        URL.revokeObjectURL(url);
    }
</script>
{% endblock %}

